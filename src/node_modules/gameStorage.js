/*==============================================================================
 *  Title      : Game storage
 *  Author     : Digger (c) SAD-Systems <http://sad-systems.ru>
 *  Created on : 18.06.2016
 *==============================================================================
 */

var localStorage   = require('localStorage'),
    stateStorage   = require('stateStorage').getInstance(),
    playerInstance = require('playerFactory').getInstance();

var data = {
    
    //--- Game data:
    scene       : '',
    map         : null,
    positionX   : null,
    positionY   : null,
    collected   : [],
    firestate   : 0,
    gamestate   : {}
    
};

var storageName;

//==============================================================================
// Exports module values:
//==============================================================================

module.exports = {
    
    save: function (gameName) {
        
        //--- To pack collected goods:
        var collected = []; //console.log(playerInstance.collectedGoods);
        for (var i in playerInstance.collectedGoods) {
            var tile = playerInstance.collectedGoods[i];
            collected.push({
                layer :tile.layer.name,
                index :tile.index,
                x     :tile.x,
                y     :tile.y,
                width :tile.width,
                height:tile.height
            });
        }
        
        data = {
            //--- Player:
            positionX : playerInstance.getPlayerX(),
            positionY : playerInstance.getPlayerY(),
            collected : collected,
            firestate : playerInstance.fireState,
            //--- Scene & Map:
            scene     : stateStorage.currentSceneName,
            map       : stateStorage.currentMapName,
            gamestate : stateStorage.getStorage()
        };
        localStorage.save(gameName, data);
        
    },
    
    load: function (gameName) {
        
        var savedGameData = localStorage.load(gameName);
        if (savedGameData) {
            Phaser.Utils.extend(true, data, savedGameData);
            return data;
        } else {
            return false;
        }
        
    },
    
    init: function () {
        
        //--- Scene & Map:
        stateStorage.setStorage(data.gamestate);
        stateStorage.lastGameMapName = data.map;
        //--- Player:
        playerInstance.fireState = data.firestate;
        playerInstance.lastGameX = data.positionX;
        playerInstance.lastGameY = data.positionY;
        //--- To unpack collected goods:
        for (var i in data.collected) {
            var tile = data.collected[i];
            playerInstance.collectedGoods.push(new Phaser.Tile({name:tile.layer}, tile.index, tile.x, tile.y, tile.width, tile.height)); 
        }

    }

};