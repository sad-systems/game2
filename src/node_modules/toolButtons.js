/*==============================================================================
 *  Title      : Tool buttons class
 *  Author     : Digger (c) SAD-Systems <http://sad-systems.ru>
 *  Created on : 04.05.2016
 *==============================================================================
 */

//------------------------------------------------------------------------------
// Private
//------------------------------------------------------------------------------

//------------------------------------------------------------------------------
// Class
//------------------------------------------------------------------------------

/**
 * Constructor
 * 
 * @param   {object} options    The JS object with initial class parameters
 * @returns {object}            A new instance of this class
 */
var __theClass = function (options) {
    
    //--- Default class config:
    this.config = {
        game: null,
        x:0,
        y:0,
        xIndent: 2,
        leftSide: true,
        initState: 0, //0=hidden, 1=visible
        buttons: {
            //Fullscreen:{ state:game.scale.isFullScreen, onDown:function(o){ game.extentions.sceneManager.gotoFullScreen(); o.setState(game.scale.isFullScreen); } },
            //Music:     { state:0, onDown:function(o){ o.setState(!o.state); console.log('Music: ' + o.state); } },
            //Sound:     { state:0, onDown:function(o){ o.setState(!o.state); console.log('Sound: ' + o.state); } },
            //Gamepad:   { state:gp.groupButtons.visible, onDown:function(o){ gp.toggleWithInverse(); o.setState(gp.groupButtons.visible); } },
            //Settings:  {},
            //Menu:      { onDown:function(o){ game.extentions.sceneManager.next(menuScene); } }
        },
        atlasId: 'toolButtons',
        frameStateNames: [
            '',     //--- 0 Normal
            'Over', //--- 1 Over 
            'Down'  //--- 2 Down
        ],
        frameControlName:  'Settings',
        frameDefaultName:  'Default',
        frameExt:          '.png' 
    };

    //--- Init the class:
    this.init(options);
    
    return this;
};

/**
 * Initialization
 * 
 * @param {object} options  The JS object with initial class parameters
 */
__theClass.prototype.init = function (options) {
    
    //--- Extend the config:
    Phaser.Utils.extend(true, this.config, options); // Phaser
    
    this.game        = this.config.game;
    this.buttons     = this.config.buttons;
    this.leftSide    = this.config.leftSide;
    this.CONTROL_KEY = this.config.frameControlName;
    
    this.createButtons();
    
};

__theClass.prototype.refresh = function () {
    //----------
    this.x = this.leftSide ? this.config.x : this.game.camera.width - this.config.x;
    this.y = this.config.y;
    //----------
    this.groupToolsButtons.x = this.x;
    this.groupToolsButtons.y = this.y;
    //--- Camera fixed:
    this.groupToolsButtons.fixedToCamera = true;
    this.groupToolsButtons.cameraOffset.x = this.x;
    this.groupToolsButtons.cameraOffset.y = this.y;
    //--------------------- 
    this.createSlideAnimations();
    this.applyMask();
    if ( !this._btControl._data.state ) {
        this._btControl._data.state = 1;
        this.toolsPressed(); 
    }
};

__theClass.prototype.createButtons = function () {
   
    this.groupToolsButtons = this.game.add.group();
    
    this._x  = 0;
    this._y  = 0;
    this._dx = this.leftSide ? 1 : -1;    
    
    //--- Control button:
    this.buttons[this.CONTROL_KEY] = { onDown:function(o){ this.toolsPressed(); }.bind(this) };
    
    for (var name in this.buttons) {
        var button       = this.buttons[name];
            button       = button || {};
            button.name  = button.name || name;
            button.state = typeof(button.state) === 'undefined' ? 1 : button.state ;
            button.x     = button.x || 0;
            button.y     = button.y || 0;
        button.own = this.addButton(button);
    }
    
    this._btControl = this.buttons[this.CONTROL_KEY].own;
    this._btControl._data = { state : this.config.initState };
    
    this.refresh();
};

__theClass.prototype.setButtonState  = function (button, state) { button.state = state; this.showButtonState(button); };
__theClass.prototype.showButtonState = function (button) {
    switch (button.state){
        case 0: // unchecked
        case false:
            button.alpha = 0.5;
            break;
        case 1: // checked
        case true:
            button.alpha  = 1; 
            break;
    }
    button._alpha = button.alpha;
};

__theClass.prototype.isFrameExists = function(frameName) { return this.game.cache.getFrameByName(this.config.atlasId, frameName) ? true : false; };
__theClass.prototype.getFrameName  = function(frameBaseName, stateIndex) { 
    return frameBaseName + this.config.frameStateNames[stateIndex ? stateIndex : 0] + this.config.frameExt;
};

__theClass.prototype.addButton = function (button) {
    
    var frameBaseName  = button.name;
    var frameNormal    = this.getFrameName(frameBaseName);
    if (!this.isFrameExists(frameNormal)) {
        frameBaseName = this.config.frameDefaultName;
        frameNormal   = this.getFrameName(frameBaseName);
    }
    var frameOver = this.getFrameName(frameBaseName, 1);
        frameOver = this.isFrameExists(frameOver) ? frameOver : this.getFrameName(frameBaseName);
    var frameDown = this.getFrameName(frameBaseName, 2);
        frameDown = this.isFrameExists(frameDown) ? frameDown : this.getFrameName(frameBaseName);

    var bt = this.game.make.button(0, 0, this.config.atlasId, null, this, frameOver, frameNormal, frameDown);
    
    var   x    = this._x + button.x * this._dx,
          y    = this._y + button.y;  
    this._x   += bt.width * this._dx;
    this._w    = this._x;
    this._x   += this.config.xIndent * this._dx;
    var height = bt.height + button.y;
    this._h    = this._h > height ? this._h : height;
    
    bt.x     = x;
    bt.y     = y;
    bt.name  = button.name;
    bt.state = button.state;
    var self = this;
    bt.setState = function(state) { self.setButtonState(this, state); };
    this.leftSide ? bt.anchor.setTo(0, 0) : bt.anchor.setTo(1, 0);
    this.showButtonState(bt);
    if (bt.name == this.CONTROL_KEY)
        bt.alpha  = 0.5;
        bt._alpha = bt.alpha;
    bt.onInputOver.add(function(o){ o.alpha = 0.75; });
    bt.onInputOut.add (function(o){ o.alpha = o._alpha; });
    //bt.onInputOver.add(function(o){ o.blendMode = PIXI.blendModes.SCREEN; });
    //bt.onInputOut.add (function(o){ o.blendMode = PIXI.blendModes.NORMAL; });
    if (typeof(button.onDown) === 'function') bt.onInputDown.add(button.onDown);
    if (typeof(button.onUp) === 'function')   bt.onInputUp.add(button.onUp);
        
    this.groupToolsButtons.add(bt);
    
    return bt;
};

__theClass.prototype.applyMask = function() {
    //	A mask is a Graphics object
    //var bounds = this.groupToolsButtons.getBounds();
    if (this.groupToolsButtons.mask) this.groupToolsButtons.mask.destroy();
    var mask = this.game.add.graphics(0, 0);
        mask.fixedToCamera = true;
        mask.beginFill(0xffffff);
    //    mask.drawRect(bounds.x, bounds.y, bounds.width*2, bounds.height);
        mask.drawRect(this.x, this.y, this._w*2, this._h);
    //	And apply it to the Sprite
    this.groupToolsButtons.mask = mask;    
};


__theClass.prototype.createSlideAnimations = function () {
    
    function changeState() { this._btControl._data.state = !this._btControl._data.state; }
    
    var group = this._btControl.parent;
        oHide = { x: this.x - this._btControl.x },
        oShow = { x: this.x },
        delayHide  = 1000,
        delayShow  = 500,
        easingHide = Phaser.Easing.Cubic.Out,
        easingShow = Phaser.Easing.Cubic.Out; //Phaser.Easing.Elastic.Out,

    this.tweenHide = this.game.add.tween(group.cameraOffset);
    this.tweenShow = this.game.add.tween(group.cameraOffset);
    this.tweenHide.onComplete.add(changeState, this);
    this.tweenHide.to(oHide, delayHide, easingHide);
    this.tweenShow.onComplete.add(changeState, this);    
    this.tweenShow.to(oShow, delayShow, easingShow);

};
        
__theClass.prototype.toolsPressed = function () {
    
    this._btControl._data.state ? this.tweenHide.start() : this.tweenShow.start();
                    
}; 


//------------------------------------------------------------------------------
// Exports module values:
//------------------------------------------------------------------------------

module.exports = {
    
    /**
     * The class to inherit
     */
    theclass: __theClass,
    
    /**
     * The class factory
     * 
     * @param   {object} options The JS object with initial class parameters
     * @returns {object}         A new object of this class
     */
    create: function (options) { 
        return new __theClass(options); 
    },
    
    preload: function (game) {
        game.load.atlas('toolButtons', 'assets/sprites/controls/tools.png', 'assets/sprites/controls/tools.json');
    }
    
};



