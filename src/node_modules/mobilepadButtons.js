/*==============================================================================
 *  Title      : Mobilepad buttons
 *  Author     : Digger (c) SAD-Systems <http://sad-systems.ru>
 *  Created on : 07.06.2016
 *==============================================================================
 */

//------------------------------------------------------------------------------
// Private
//------------------------------------------------------------------------------

//==============================================================================
// The Class
//==============================================================================

/**
 * Constructor
 * 
 * @param   {object} options    The JS object with initial class parameters
 * @returns {object}            A new instance of this class
 */
var mobilepadButtons = function (options) {

    this.game    = null;
    this.group   = null;
    this.buttons = {
        A:{},
        B:{},
        C:{},
        //D:{},
        joystick: {
        }
    };

    this._buttons = {};

    this._create(options);
    return this;

};

mobilepadButtons.prototype = {
//------------------------------------------------------------------------------
// Config
//------------------------------------------------------------------------------

    offsetX: 0,
    offsetY: 0,
    inverse: true,
    
//------------------------------------------------------------------------------
// Protected
//------------------------------------------------------------------------------

    /**
     * Initialization
     * 
     * @protected
     * @param {object} options  The JS object with initial class parameters
     */
    _init: function (options) {

        //--- Extend the instance:
        Phaser.Utils.extend(true, this, options); // by Phaser

    },
    
    _extend: function (source, dest) {
        return Phaser.Utils.extend(true, source, dest);
    },

    _show: function (obj) {
        obj.visible = true;
    },
    
    _hide: function (obj) {
        obj.visible = false;
    },

    _drawJoystick: function () {
        
        var  joystick = this.buttons.joystick,
            _joystick = this._buttons['joystick'];
        if (_joystick) _joystick.destroy();
        
        _joystick = this.game.make.graphics(joystick.cx, joystick.cy);
        _joystick.lineStyle(0); //1, 0xffffff, 0.5); 
        _joystick.beginFill(0xffffff, 0.25);
        _joystick.drawCircle(0, 0, joystick.d);
        _joystick.endFill();
        
        _joystick._params = joystick;
        
        this._buttons['joystick'] = _joystick;
        
        this._hide(_joystick); //<--- hide by default
        
        return _joystick;
        
    },

    _drawPad: function (name) {
        
        var  pad = this.buttons[name],
            _pad = this._buttons[name];
        if (_pad) _pad.destroy();
        
        _pad = this.game.make.graphics(pad.cx, pad.cy);
        _pad.lineStyle(0); //1, 0xffffff, 0.5); 
        _pad.beginFill(0xffffff, 0.25);
        _pad.drawCircle(0, 0, pad.d);
        _pad.endFill();
        
        _pad._params = pad;

        this._buttons[name] = _pad;
        
        this._hide(_pad); //<--- hide by default
        
        return _pad;
    },
    
    _setJoystic: function () {
        
        var radius   = this.game.height / 4,
            diameter = radius*2,
            x0       = this.inverse ? this.game.width - radius - this.offsetX: radius + this.offsetX,
            y0       = this.game.height - radius - this.offsetY;
        this.buttons.joystick = this._extend(this.buttons.joystick, {cx: x0, cy:y0, d:diameter});
        
        //--- Add to the group:
        this.group.add( this._drawJoystick() );
        
    },
    
    _setPad: function () {
        
        var length = 0;
        var pads   = [];
        for(var name in this.buttons) {
            if (name == 'joystick') continue;
            pads[length] = this.buttons[name];
            length++; 
        }
        if (length == 0) return;
        
        var center   = this.game.height / 4,
            offset   = center / 1.7,
            radius   = this.game.height / 10,
            diameter = radius*2,
            x0       = !this.inverse ? this.game.width - center - this.offsetX: center + this.offsetX,
            y0       = this.game.height - center - this.offsetY;

        switch (length) {
            case 1:
                pads[0] = this._extend(pads[0], {cx:0, cy:0, d:diameter});
                break;
            case 2:
                offset = center / 2.3;
                pads[0] = this._extend(pads[0], {cx:x0 + 0, cy:y0 - offset, d:diameter});
                pads[1] = this._extend(pads[1], {cx:x0 + 0, cy:y0 + offset, d:diameter});
                break;
            case 3:
                pads[0] = this._extend(pads[0], {cx:x0 + 0, cy:y0 - offset, d:diameter});
                pads[1] = this._extend(pads[1], {cx:x0 + 0, cy:y0 + offset, d:diameter});
                pads[2] = this._extend(pads[2], {cx:x0 + offset * (this.inverse ? -1: 1), cy: y0 + 0, d:diameter});
                break;
            case 4:
                pads[0] = this._extend(pads[0], {cx:x0 + 0, cy:y0 - offset, d:diameter});
                pads[1] = this._extend(pads[1], {cx:x0 + 0, cy:y0 + offset, d:diameter});
                pads[2] = this._extend(pads[2], {cx:x0 - offset, cy:y0 + 0, d:diameter});
                pads[3] = this._extend(pads[3], {cx:x0 + offset, cy:y0 + 0, d:diameter});
                break;
        }
       
        //--- Add to the group:
        for (var name in this.buttons) {
            if (name == 'joystick') continue;
            this.group.add( this._drawPad(name) );
        }
        
    },
    
    _isPointerInside: function (pointer, obj) {
        
        var p = pointer.position,
            b = obj.getBounds();
        if (p.x > b.left && p.x < b.right && p.y > b.top && p.y < b.bottom)
            return true;
        return false;
        
    },
    
    _press: function (obj) {
        
        this._show(obj);
        
    },

    _release: function (pointer) {
        
    },

   
   
    _onMove: function(pointer) {
        
        for (var name in this._buttons) {
            if (this._isPointerInside(pointer, this._buttons[name])) {
                this._press(this._buttons[name]);
            } else {
                this._hide(this._buttons[name]);
            }
        }
        
        
    },
    
    _create: function (options) {
        
        this._init(options);
        this.group = this.group || this.game.add.group();
        //--- Camera fixed:
        this.group.fixedToCamera = true;
        this.group.cameraOffset.x = 0;
        this.group.cameraOffset.y = 0;
        //this.group.visible = true; // false; // true;
        //---------------------
        this.setButtons();
        //--- Handler:
        this.game.input.onUp.add(this._release,   this);     //--- release
        this.game.input.addMoveCallback(this._onMove, this); //--- press
        
    },    
    
//------------------------------------------------------------------------------
// Public
//------------------------------------------------------------------------------

    setButtons: function () {
        this._setJoystic();
        this._setPad();
    }

};

//==============================================================================
// Exports module values:
//==============================================================================

module.exports = {
    /**
     * The class to inherit
     * 
     * example:
     * 
     * function childClass() {
     *      theclass.apply(this, arguments);
     * }
     * 
     * childClass.prototype = Object.create(theclass.prototype);
     * childClass.prototype.constructor = childClass;
     * 
     */
    theclass: mobilepadButtons,
    
    /**
     * The class factory
     * 
     * @param   {object} options The JS object with initial class parameters
     * @returns {object}         A new instance of this class
     */
    create: function (options) {
        return new mobilepadButtons(options);
    },
    
    preload: function (game) {
        game.load.atlas('mobilepadButtons',  'assets/sprites/controls/gamepad.png', 'assets/sprites/controls/gamepad.json');
        game.load.image('mobilepadJoystick', 'assets/sprites/controls/joystick2.png');
    }


};